<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>REAS API tester</title>
  <meta name="description" content="The HTML5 Herald">
  <meta name="author" content="SitePoint">

  <link rel="stylesheet" href="css/siimple.min.css">
</head>
  <link rel="icon" href="favicon.png">

<body onload="appStart()" onunload="appClose()">
<div style="max-width:900px; margin:0 auto;" >
    <div class="siimple-box siimple-box--green">
        <div class="siimple-box-title">REAS API tester</div>
        <div class="siimple-box-subtitle">HTTP GET request generator for local devices</div>
        <div class="siimple-box-detail">
            <a class="siimple-link" 
               href="https://github.com/critBit95/REAS">
               github.com/critBit95/REAS
            </a>
        </div>
    </div>
    <div class="siimple-grid">
        <div class="siimple-grid-row">
            <!-- Left part of the window-->
            <div class="siimple-grid-col siimple-grid-col--8">
                <!-- HTML of the manual query window-->
                <div class="siimple-card-header">
                    <label class="siimple-label">Insert your HTTP GET query:</label>
                </div>
                <div class="siimple-card-body">
                    <form>
                        <label class="siimple-label">http://</label>
                        <input type="text" 
                            class="siimple-input"
                            size="10" 
                            id="ipAddr" 
                            value="192.168.2.200" 
                            onchange="console.log('test');setIP(this.value)"
                        >
                        <label class="siimple-label">/?</label>
                        <input type="text" 
                            class="siimple-input" 
                            id="param" 
                            value="mul=01010101" 
                        >
                        <button type="button"
                            style="height: 0px; 
                                    width: 0px; 
                                    border: none; 
                                    padding: 0px;" 
                            hidefocus="true" 
                        >
                    </form>                    
                </div>
                <div class="siimple-card-footer">
                    <div class="siimple-btn siimple-btn--orange" 
                         onclick="httpGetFromQueryBox()">
                         Send!
                    </div>
                </div>
                <br>
                <div class="siimple-card-header">
                    <label class="siimple-label">Recent query:</label>
                </div>
                <div class="siimple-card-body">
                    <textarea readonly id="queryDisp" class="siimple-textarea" rows="2" style="width:96%">
No query performed
                    </textarea>
                </div>
                <div class="siimple-card-footer">       
                </div>
                <br>
                <!-- Device response window-->
                <div class="siimple-card-header">
                    <label class="siimple-label">REAS' recent response:</label>
                </div> 
                <div class="siimple-card-body">
                    <textarea readonly id="respDisp" class="siimple-textarea" rows="5" style="width:96%">
Nothing (yet!)
                    </textarea>
                </div>
            </div>
            <!-- HTML of the antenna control panel-->
            <div class="siimple-grid-col siimple-grid-col--4">
                <div class="siimple-card-header">
                        <label class="siimple-label">
                            REAS Device status:
                            <span id="deviceStatusTag" class="siimple-tag siimple-tag--dark siimple-tag--rounded">Unknown</span>
                        </label>
                    </div>
                    <!-- Antenna switch list, populated by JS-->
                    <div class="siimple-card-body">
                        <div id="antennaList" class="siimple-list siimple-list--hover">
                                This webapp works only with JavaScript enabled. 
                                Please check your settings.
                            </div>
                    </div>
                    <!-- Antenna switch list, populated by JS-->
                    <div class="siimple-card-footer">
                        <label class="siimple-label">Exclusive antena mode:</label>
                        <div class="siimple-checkbox">
                            <input type="checkbox" id="singleAntModeBox" onChange="setSingleAntennaMode()" checked>
                            <label for="singleAntModeBox"></label>
                        </div>
                        <!--
                        <label class="siimple-label">Update status every 5s:</label>
                        <div class="siimple-checkbox">
                            <input type="checkbox" id="updateModeSwitch" checked>
                            <label for="updateModeSwitch"></label>
                        </div>
                        -->
                        <div id="toggleSetupModeBut" class="siimple-btn siimple-btn--orange" 
                            onclick="toggleSetupMode()">
                            Enter setup mode
                        </div>
                    </div>
                    <br>
                    <div id="localStorageConsentWindow" class="siimple-alert siimple-alert--warning">
                        Are you okay with storing some antenna config in your browser? [TODO: PREVENT REAPPEARING ON CONSENT]
                        <br>
                        <div class="siimple-btn siimple-btn--warning"
                            onclick="enableLocalStorage()">
                            I consent.
                        </div>
                        <div class="siimple-btn siimple-btn--error" 
                            onclick="disableLocalStorage()">
                            I do not.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="siimple-footer siimple-footer" align="center">
        Made with love using <strong>siimple</strong> - easy, lightweight and fun CSS framework
    </div>
</div>



<script src="js/jsonConfigController.js">
</script>
<script>
    /** global variables **/
    var req = "";
    var setupMode = false;
    var jsonConfigController;
   

    /** webapp start and finish **/

    function appStart(){
        jsonConfigController = new JsonConfigController;
        guiController = new GuiController;
        drawAntennaList();
        document.getElementById("ipAddr").value = jsonConfigController.getIP();
    }

    function appClose(){
        jsonConfigController.saveSettingsOnLocalStorage()
    }

    /** Local Storage functionality **/

    function enableLocalStorage(){
        jsonConfigController.enableLocalStorage();
        document.getElementById('localStorageConsentWindow').style.display = "none";
    }

    function disableLocalStorage(){
        jsonConfigController.disableLocalStorage();
        document.getElementById('localStorageConsentWindow').style.display = "none";
    } 

    function setIP(){
        jsonConfigController.setIP(document.getElementById("ipAddr").value);
    }

    function setAntName(antNo){
        jsonConfigController.setAntName(antNo,
                                        document.getElementById("antListName"+antNo).value);
    }

    function toggleAntenna(antNo){
        switch (jsonConfigController.getAntVal(antNo)){
            case "off":
                jsonConfigController.setAntVal(antNo,"on");
                break;
            case "on":
                jsonConfigController.setAntVal(antNo,"off");
                break;
            default:
                jsonConfigController.setAntennasOff();
                break;
        }
        drawAntennaList();
        httpGet(getApiRequestFromJsonConfig(),handleServerResponse);
    }

    function setAntennasOff(){
        jsonConfigController.setAntennasOff();
    }

    function setSingleAntennaMode(){
        jsonConfigController.setSingleAntennaMode(
            document.getElementById("singleAntModeBox").checked
        );
        drawAntennaList();
    }

    function setAntennaCount(){
        jsonConfigController.setAntennaCount(
            document.getElementById("antSetupCount").value
        );
    }

    function getApiRequestFromJsonConfig(){
        var request = "http://"+
                document.getElementById('ipAddr').value +
                "/?mul=";
        for (i in jsonConfigController.jsonConfig.antenna){
            if(jsonConfigController.jsonConfig.antenna[i].state == "on"){
                request+="1";
            }
            else{
                request+="0";
            }
        }
        return request
    }

    /** Local area network and REAS API functionality **/

    function getRemoteAntennaStatus(){
        
    }

    function getRequestFromInterface(){

    }

    function reqStrUpdate() {
        req = guiController.getUrlFromQueryBox();
        guiController.updateQueryDisp(req); 
    }
    
    function httpGetFromQueryBox(){
        req = guiController.getUrlFromQueryBox();
        httpGet(req,handleServerResponse);
    }


    function handleServerResponse(responseStatus,responseText){
        var textToDisplay;
        
        if(responseStatus == 200){
            textToDisplay = "Valid request. Response:\n" + responseText;
            drawDeviceStatus("Online");
        }

        /** request error **/
        else if(responseStatus == -1){
            textToDisplay = "http request error:\n" + responseText;
            drawDeviceStatus("Error");
        }
        /** request timeout **/
        else if(responseStatus == 0){
            textToDisplay = "http request timeout:\n" + responseText;
            drawDeviceStatus("Offline");
        }
        /** Error: not found **/
        else if(responseStatus == 404){
            textToDisplay = "Server responded but parameter not found:\n" + responseText;
            drawDeviceStatus("Error");
        }
        /** Error: different error **/
        else {
            textToDisplay = "Server responded with undefined error no.:\n" + responseText;
            drawDeviceStatus("Error");
        }
        updateRespDisp(textToDisplay);
    }

    function httpGet(param,onLoadFunctionHandle = null)
    {
        guiController.updateQueryDisp(param);
        guiController.updateRespDisp("Waiting for response...");
        console.log("param: " + param);
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.open( "GET", param, true );
        xmlHttp.onload = function (e) {
            if (xmlHttp.readyState === 4) {
                onLoadFunctionHandle(xmlHttp.status,xmlHttp.responseText)
            }
        };
        xmlHttp.timeout = 1000;
        xmlHttp.ontimeout = function (e) {
            onLoadFunctionHandle(0,"timeout");
        };
        xmlHttp.onerror = function (e) {
            onLoadFunctionHandle(-1,"Error");
        };
        console.log("Starting query...");
        xmlHttp.send( null );
    }


    /** Rendering HTML section **/

/////////////////////////////////////






    class GuiController{



        constructor(){
            console.log("guiController constructor called...")
            this.jsonGuiTree = this.getJsonGuiTree()
        }

        getJsonGuiTree(){
            return {
                queryBox :{
                    textInputIpAddr : document.getElementById('ipAddr'),
                    textInputParam : document.getElementById('param')
                },
                queryDisplayBox :{
                    textAreaQueryDisp : document.getElementById("queryDisp")
                },
                responseBox :{
                    textAreaRespDisp : document.getElementById("respDisp")
                },
                antControlBox :{
                    tagDeviceStatus : document.getElementById("deviceStatusTag"),
                    antennaList : [],
                    checkBoxSignleAntMode : document.getElementById("singleAntModeBox"),
                    buttonToggleSetupMode : document.getElementById("toggleSetupModeBut")
                }
            }
        }

        getUrlFromQueryBox(){
            return "http://"
                    + this.jsonGuiTree
                        .queryBox
                        .textInputIpAddr.value
                    + "/?"
                    + this.jsonGuiTree
                        .queryBox
                        .textInputParam.value;
        }

        getQueryFromQueryBox(){
            return "http://"
                    + this.jsonGuiTree
                        .queryBox
                        .textInputIpAddr.value
        }

        setSetupMode(mode){
            if (mode == true){
                this.jsonGuiTree
                    .antControlBox
                    .buttonToggleSetupMode
                    .innerHTML = "Leave setup mode"
            }
            else{
                this.jsonGuiTree
                    .antControlBox
                    .buttonToggleSetupMode
                    .innerHTML = "Enter setup mode"
            }
        }

        updateQueryDisp(text){
            this.jsonGuiTree
                .queryDisplayBox
                .textAreaQueryDisp
                .innerHTML = text
            console.log("query:\n " + text);
        }

        updateRespDisp(text){
            this.jsonGuiTree
                .responseBox
                .textAreaRespDisp
                .innerHTML = text
                console.log("response:\n " + text);
        }

        drawDeviceStatus(statusText){
            var statusColor;
            switch (statusText){
                case "Online":
                    statusColor = "success";
                    break;
                case "Offline":
                    statusColor = "dark"
                    break;
                case "Error":
                    statusColor = "error"
                    break;
                default:
                    statusText = "Unknown";
                    statusColor = "light";
                    break;
            }
            this.jsonGuiTree
                .antControlBox
                .tagDeviceStatus
                .innerHTML = statusText;
            this.jsonGuiTree
                .antControlBox
                .tagDeviceStatus
                .className = "siimple-tag siimple-tag--"
                             + statusColor
                             + " siimple-tag--rounded";
        }

        drawAntennaList(jsonConfig,setupMode){
            var htmlText = "";
            if (setupMode) htmlText += "<h3>SETUP MODE</h3>";
            for(var i=0;i<jsonConfig.antennaCount;i++){
                var listItemText = "";
                var statusColor;
                var statusText;

                /** setup tag name and color from jsonConfig **/
                if (jsonConfig.antenna[i].state == 'on'){
                    statusColor = "success"
                    statusText = "On"
                }
                else if (jsonConfig.antenna[i].state == 'off'){
                    statusColor = "primary"
                    statusText = "Off"
                }
                else{
                    statusColor = "error"
                    statusText="??"
                }
                
                var listItemOnClickText = ((setupMode) ? 
                            "" :
                            'onClick="toggleAntenna('+ (i) +')"'
                            );
                
                var listItemTextReadonlyText = ((setupMode) ?
                            "" :
                            'readonly="true"'
                            );

                var listItemTextText = ((setupMode) ? 
                            /** draw input fields **/
                            '<input type="text" class="siimple-input" size="20"' +
                            'id="antListName' + i + '" value="' + jsonConfig.antenna[i].name + '" onchange="setAntName(' + (i) + ')">' :
                            /** draw plain text with names **/
                            '<div class="siimple-p" style="display: inline-block">' +  jsonConfig.antenna[i].name + '</div>'
                            );


                //addd HTML to string variable
                listItemText+= '<div class="siimple-list-item"' + listItemOnClickText + '>';
                    //drawind input field/name field
                    listItemText += listItemTextText;
                    //drawing tag
                    listItemText+= '<span class="siimple-tag siimple-tag--' + statusColor + 
                                    ' siimple-tag--rounded">' + statusText + "</span>";
                listItemText+= "</div>"
                htmlText += listItemText;
            }
            //end of drawing antennas in for loop


            /** drawing stuff under the antenna list **/
            if(setupMode){
                /** drawing antenna count input field **/
                htmlText += '<br><label class="siimple-label"> Antenna Count</label>' +
                '<input id="antSetupCount" type="number" min=1 max='+ jsonConfigController.maxAntCount +' class="siimple-input"'+
                'onchange="setAntennaCount()" placeholder="' + jsonConfigController.jsonConfig.antennaCount + '">'
            }
            else{
                /** drawing turnAllOff button **/
                htmlText += '<div class="siimple-list-item" onClick="toggleAntenna(-1)"><p> turn all off </p></div>'
            }
            document.getElementById("antennaList").innerHTML = htmlText;
        }

        

    }


    function toggleSetupMode(){
        if (setupMode == true){
            setupMode = false;
        }
        else {
            setupMode = true;
        }
        guiController.setSetupMode(setupMode);
        drawAntennaList();
    }

    function updateRespDisp(text){
        guiController.updateRespDisp(text);
    }
 
    function updateQueryDisp(text){
        guiController.updateQueryDisp(text);
    }    

    function drawDeviceStatus(statusText){
        guiController.drawDeviceStatus(statusText);
    }

    function drawAntennaList(){
        guiController.drawAntennaList(jsonConfigController.jsonConfig,setupMode)
    }
    

    
</script>
</body>
</html>



